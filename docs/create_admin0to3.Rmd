---
title: "Create Admin0 to 3"
output: html_notebook
---


The good news brigade is back at it, looking for angles with which to interpret count data that support a happy or underdog story.

```{r}
#libraries
library(lubridate)
library(tidyverse)

#devtools::install_github("ropensci/USAboundaries")
#devtools::install_github("ropensci/USAboundariesData")
library(USAboundaries) ; #install.packages('USAboundaries')
data(state_codes)

library(tidyverse)
library(scales)
library(gghighlight)
library(lubridate)
library(R0)  # consider moving all library commands to top -- this one was in a loop below

library(WikidataR)
library(countrycode)

library(usmap) ; # install.packages('usmap')
data(statepop)
#devtools::install_github("ropensci/USAboundaries")
#devtools::install_github("ropensci/USAboundariesData")
library(USAboundaries) ; #install.packages('USAboundaries')
data(state_codes)

library(tidyverse)
library(sf)

library(tidycensus)

```

```{r}
#This requires java 8, which was installed but not set as default. Rather than downgrade, there's a trick here to pick the automatic one
#sudo update-alternatives --config java
#https://askubuntu.com/questions/994515/how-to-downgrade-java-jre-the-ubuntu-way

#devtools::install_github("rstudio/sparklyr")

library(sparklyr)
#spark_install()

#options(sparklyr.java9 = TRUE)
restartspark <- function(mem="180G"){
  library(tidyverse)
  library(sparklyr)
  library(dplyr)
  library(replyr)
  library(tictoc)
  library(arrow)
  try({spark_disconnect(sc)})
  
  #https://spark.rstudio.com/deployment/
  #https://stackoverflow.com/questions/41645679/spark-driver-memory-and-executor-memory
  conf <- spark_config()
  #conf$spark.executor <- 1 #one executor per computer
  #conf$spark.executor.cores <- 24 #number of cores per executor
  #conf$"sparklyr.shell.executor-memory"="100G" #supposedly is ignored when running local
  conf$spark.memory.fraction <- 0.6
  conf$spark.executor.heartbeatInterval <-"6000000s"# "10000000s"
  conf$spark.network.timeout <- "6000001s"
  conf$spark.local.dir <- "/media/skynet2/905884f0-7546-4273-9061-12a790830beb/spark_temp/"
  conf$spark.worker.cleanup.enabled <- "true"
  #conf$spark.worker.cleanup.interval <- 60 #one minute
  
  #config$sparklyr.cores.local= 46
  #config$"sparklyr.shell.executor-cores"=4
  #config$"sparklyr.shell.driver-cores"=4
  
  conf$"sparklyr.shell.driver-memory"= mem
  conf$'spark.driver.maxResultSize' <- 0 #0 is ulimmited
  sc <<- spark_connect(master = "local", config = conf) #, version = "2.1.0" for graphframes
}
```

# Unit of Analysis


## Country codes

```{r}

library(countrycode)
gadm36 = st_read("/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESSgadm/data_in/gadm36_gpkg/gadm36.gpkg")

gadm36_df <- gadm36 %>% as.data.frame()

countries <- gadm36_df %>% dplyr::select(gid=GID_0, name=NAME_0 ) %>% distinct()


exclude <- c("ar5", "continent", "country.name.de.regex", "country.name.en.regex", "eurocontrol_pru", "eurocontrol_statfor", "icao.region", "region",
             "cldr.variant.ccp","cldr.variant.dz", "cldr.variant.ce", "cldr.variant.brx","cldr.variant.bn_in","cldr.variant.bn","cldr.variant.fa","cldr.variant.fa_af", "cldr.variant.ja","cldr.variant.ka",
             "cldr.variant.kk","cldr.variant.km","cldr.variant.kn","cldr.variant.ko","cldr.variant.ko_kp","cldr.variant.kok","cldr.variant.ks","cldr.variant.lo","cldr.variant.my","cldr.variant.mzn","cldr.variant.ne",
             "cldr.variant.or","cldr.variant.pa","cldr.variant.ps","cldr.variant.sd","cldr.variant.shi","cldr.variant.si","cldr.variant.sr","cldr.variant.sr_cyrl_ba","cldr.variant.sr_cyrl_me","cldr.variant.sr_cyrl_xk","cldr.variant.ta",
             "cldr.variant.te","cldr.variant.th","cldr.variant.ti","cldr.variant.ug","cldr.variant.uk","cldr.variant.ur","cldr.variant.ur_in","cldr.variant.uz_cyrl","cldr.variant.vai","cldr.variant.yi","cldr.variant.yo","cldr.variant.yo_bj",
             "cldr.variant.yue","cldr.variant.yue_hans","cldr.variant.zgh","cldr.variant.zh","cldr.variant.zh_hant","cldr.variant.zh_hant_hk",
             "un.name.ar","un.name.ru","un.name.zh","cldr.name.am","cldr.name.ar","cldr.name.ar_ly","cldr.name.ar_sa","cldr.name.as","cldr.name.az","cldr.name.az_cyrl",
             "cldr.name.be","cldr.name.bg","cldr.name.bm","cldr.name.bn","cldr.name.brx","cldr.name.bs_cyrl","cldr.name.ccp","cldr.name.ce","cldr.name.chr","cldr.name.chr","cldr.name.ckb","cldr.name.dz","cldr.name.el",
             "cldr.name.fa","cldr.name.fa_af","cldr.name.gu","cldr.name.he","cldr.name.hi","cldr.name.hy","cldr.name.ja","cldr.name.ka","cldr.name.km","cldr.name.kn","cldr.name.ko",
             "cldr.short.yo_bj"  ,    "cldr.name.tk"         , "cldr.short.tk"        , "cldr.variant.tk"      , "cldr.name.mgh"     ,    "cldr.short.mgh"     ,   "cldr.variant.mgh"      ,"cldr.short.el"        , "cldr.variant.el"   ,    "cldr.name.mk"    ,     
             "cldr.name.sr"     ,     "cldr.name.sr_cyrl_ba" , "cldr.name.sr_cyrl_me" , "cldr.name.sr_cyrl_xk" , "cldr.short.mk"    ,     "cldr.short.sr"      ,   "cldr.short.sr_cyrl_ba", "cldr.short.sr_cyrl_me", "cldr.short.sr_cyrl_xk", "cldr.variant.mk"      ,
             "cldr.name.kk"     ,     "cldr.short.kk"        , "cldr.name.ky"     ,     "cldr.name.mn"         , "cldr.name.ru"     ,     "cldr.name.ru_ua"    ,   "cldr.short.bg"        , "cldr.short.bs_cyrl" ,   "cldr.short.ky"   ,      "cldr.short.mn"       , 
             "cldr.short.ru"     ,    "cldr.short.ru_ua"     , "cldr.variant.bg"  ,     "cldr.variant.bs_cyrl" , "cldr.variant.ky"   ,    "cldr.variant.mn"    ,   "cldr.variant.ru"      , "cldr.variant.ru_ua" ,   "cldr.name.uk"    ,      "cldr.short.be"       , 
             "cldr.short.uk"      ,   "cldr.variant.be"      , "cldr.name.tg"     ,     "cldr.name.uz_cyrl"  ,   "cldr.short.tg"      ,   "cldr.short.uz_cyrl" ,   "cldr.variant.tg"      , "cldr.name.tt"       ,   "cldr.short.tt"   ,      "cldr.variant.tt"     , 
             "cldr.short.az_cyrl"  ,  "cldr.variant.az_cyrl" , "cldr.short.ce"    ,     "cldr.short.ka"      ,   "cldr.short.hy"       ,  "cldr.variant.hy"    ,   "cldr.name.yi"         , "cldr.short.yi"      ,   "cldr.short.he"   ,      "cldr.variant.he"     , 
             "cldr.short.ar"       ,  "cldr.short.ar_ly"   ,   "cldr.short.ar_sa" ,     "cldr.variant.ar"    ,   "cldr.variant.ar_ae" ,   "cldr.variant.ar_ly" ,   "cldr.variant.ar_sa"   , "cldr.name.ug"       ,   "cldr.short.ug"   ,      "cldr.short.ckb"     ,  
             "cldr.variant.ckb"   ,   "cldr.name.ps"       ,   "cldr.name.sd"     ,     "cldr.name.ur"       ,   "cldr.name.ur_in"    ,   "cldr.name.uz_arab"  ,   "cldr.short.fa"        , "cldr.short.fa_af"   ,   "cldr.short.ps"    ,     "cldr.short.sd"     ,   
             "cldr.short.ur"      ,   "cldr.short.ur_in"   ,   "cldr.name.ks"     ,     "cldr.short.ks"      ,   "cldr.name.mzn"      ,   "cldr.short.mzn"     ,   "cldr.name.shi"        , "cldr.name.zgh"      ,   "cldr.short.shi"   ,     "cldr.short.zgh"    ,   
             "cldr.name.ti"       ,   "cldr.short.am"      ,   "cldr.short.ti"    ,     "cldr.variant.am"    ,   "cldr.name.mr"       ,   "cldr.short.mr"      ,   "cldr.variant.mr"      , "cldr.name.kok"      ,   "cldr.name.ne"      ,    "cldr.short.kok"     ,  
             "cldr.short.ne"      ,   "cldr.short.hi"      ,   "cldr.variant.hi"  ,     "cldr.short.brx"     ,   "cldr.short.as"      ,   "cldr.short.bn"      ,   "cldr.variant.as"      , "cldr.name.pa"       ,   "cldr.short.pa"      ,   "cldr.short.gu"     ,   
             "cldr.variant.gu"    ,   "cldr.name.or"       ,   "cldr.short.or"    ,     "cldr.name.ta"       ,   "cldr.short.ta"      ,   "cldr.name.te"       ,   "cldr.short.te"        , "cldr.short.kn"      ,   "cldr.name.ml"        ,  "cldr.short.ml"    ,    
             "cldr.variant.ml"    ,   "cldr.name.si"       ,   "cldr.short.si"    ,     "cldr.name.th"       ,   "cldr.short.th"      ,   "cldr.name.lo"       ,   "cldr.short.lo"        , "cldr.short.dz"      ,   "cldr.name.my"       ,   "cldr.short.my"    ,    
             "cldr.short.ccp"     ,   "cldr.short.km"      ,   "cldr.short.chr"   ,     "cldr.variant.chr"   ,   "cldr.name.vai"       ,  "cldr.short.vai"     ,   "cldr.name.ko_kp"      , "cldr.short.ko"      ,   "cldr.short.ko_kp"    ,  "cldr.short.ja"    ,    
             "cldr.name.yue"      ,   "cldr.name.yue_hans" ,   "cldr.name.zh"     ,     "cldr.name.zh_hant"  ,   "cldr.name.zh_hant_hk" , "cldr.short.yue"     ,   "cldr.short.yue_hans"  , "cldr.short.zh"      ,   "cldr.short.zh_hant"  ,  "cldr.short.zh_hant_hk"
             )
length(names(codelist))
vars <- setdiff(names(codelist),exclude)
length(vars) #489
codelist_t <- t(codelist[,vars])

sort(codelist_t[,1])

countries_list <- list()
for(q in vars){
  print(q)
  temp <- countries
  temp$name <- countrycode(
    sourcevar=temp$name,
    origin="country.name",
    destination=q,
    warn = F,
    nomatch = NA,
    custom_dict = NULL,
    custom_match = NULL,
    origin_regex = FALSE
  )
  if(!is.numeric(temp$name)) { #auto exclude those columns that are numeric codes
    countries_list[[q]] <- temp
  }
}

countries_df <- bind_rows(countries_list)
dim(countries_df) #122,368
library(stringi)
rex_clean <- function(x){ x %>% stringi::stri_trans_general("latin-ascii") %>% stringi::stri_replace_all(regex="[^A-Za-z0-9]","") %>% tolower() } #so individually, each string should be devoid of spaces,noncharacters, and nonlatin

countries_df_unique <- countries_df %>% 
                       mutate(name= name %>% rex_clean()   ) %>%
                       distinct() %>% 
                       filter(!is.na(name)) %>% 
                       add_count(name) %>% filter(n==1) %>% dplyr::select(-n) %>%
                       filter(is.na(as.numeric(name)))
dim(countries_df_unique) #13,653

countries_df_unique <- bind_rows(
  gadm36_df %>% dplyr::select(gid=GID_0, name=NAME_0 ) %>% mutate(name= name %>% rex_clean()   ),
  countries_df_unique
) %>% distinct()


```

## GADM

Turns out it's not a panacea. Catches a whole lot but fails like on Delhi's second level administrative boundaries for some reason. Alternate names get poorer for some parts of the world. Also really hit or miss coverage on cities.

```{r}

gadm36 = st_read("/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESSgadm/data_in/gadm36_gpkg/gadm36.gpkg")

gadm36_df <- gadm36 %>% as.data.frame()

countries <- gadm36_df %>% dplyr::select(gid=GID_0, name=NAME_0 ) %>% distinct()

#Gadm is good about aliases for lower level entities but not countries so use countrycode to grab a bunch of other ways to write countries
#For variety, we're going to throw in all the country aliases in countrycode

temp1 <- bind_rows(
  countries_df_unique,
  gadm36_df %>% dplyr::select(gid=GID_1, name=NAME_1 , varname=VARNAME_1, type=TYPE_1, engtype=ENGTYPE_1, validfrom=VALIDFR_1, validto=VALIDTO_1 ) %>% distinct(),
  gadm36_df %>% dplyr::select(gid=GID_2, name=NAME_2 , varname=VARNAME_2, type=TYPE_2, engtype=ENGTYPE_2, validfrom=VALIDFR_2, validto=VALIDTO_2 ) %>% distinct(),
  gadm36_df %>% dplyr::select(gid=GID_3, name=NAME_3 , varname=VARNAME_3, type=TYPE_3, engtype=ENGTYPE_3, validfrom=VALIDFR_3, validto=VALIDTO_3 ) %>% distinct(),
  gadm36_df %>% dplyr::select(gid=GID_4, name=NAME_4 , varname=VARNAME_4, type=TYPE_4, engtype=ENGTYPE_4, validfrom=VALIDFR_4, validto=VALIDTO_4 )
) %>% distinct()
dim(temp1)

temp2 <- bind_rows(
  temp1 %>% dplyr::select(gid, name=name , type, engtype, validfrom, validto ),
  temp1 %>% dplyr::select(gid, name=varname , type, engtype, validfrom, validto )
)  %>%
  distinct() %>% 
  separate_rows(name,sep="\\|") %>%
  mutate(name = trimws(name)) %>%
  filter(!is.na(name) & name!='') %>%
  distinct() 

temp3 <- bind_rows(
  temp2 %>% dplyr::select(gid, name , type=type, validfrom, validto ),
  temp2 %>% dplyr::select(gid, name , type=engtype, validfrom, validto )
)  %>%
  distinct() %>% 
  separate_rows(type,sep="\\|") %>%
  mutate(type = trimws(type)) %>%
  distinct() 
dim(temp3)
#Territorio Nacional|Provincia

temp4 <- bind_rows(
  temp3 %>% dplyr::select(gid, name , validfrom, validto ), #just the name
  temp3 %>% filter(!is.na(type) & type!='') %>% mutate(name=paste0(name," ",type)) %>% dplyr::select(gid, name , validfrom, validto ), #original name followed by the type that it is
  temp3 %>% filter(!is.na(type) & type!='') %>% mutate(name=paste0(type," of ",name)) %>% dplyr::select(gid, name , validfrom, validto ), #type followed by of, so state of, county of province of, etc.
)  %>%
  distinct() %>% 
  mutate(name = trimws(name)) %>%
  distinct() 
dim(temp4) #1,657,967 #1019451

#dates
dates_df <- temp4 %>% dplyr::select(gid,validfrom, validto) %>% distinct()

library(data.table)
temp5 <- temp4 %>% dplyr::select(gid,name) %>% as.data.table()

library(dtplyr) #install.packages("dtplyr")
library(stringi)
rex_clean <- function(x){ x %>% stri_trans_general("latin-ascii") %>% stri_replace_all(regex="[^A-Za-z0-9]","") %>% tolower() } #so individually, each string should be devoid of spaces,noncharacters, and nonlatin
temp5[,name:=rex_clean(name),]
temp5 <- temp5 %>% distinct()
dim(temp5) 

#but between levels we'll put an underscore. Number of udnerscores tells you how many levels down it is
#we do this better above so we're more interested in level1 below
level0 <- countries_df_unique %>% mutate(name=rex_clean(name)) %>% distinct() %>% arrange(gid) %>% filter(!is.na(name) & name!='') %>% filter(!duplicated(name))
dim(level0) #

#temp <- level0 %>% count(name)

gadm1 <- gadm36_df %>% dplyr::select(gid=GID_1, a=GID_0, b=GID_1) %>% filter(!is.na(a) & !is.na(b)) %>% 
          #left_join(temp5 %>% dplyr::select(a=gid, name_a=name) %>% filter(!is.na(a) & !is.na(name_a) & name_a!='')  ) %>% 
          left_join(temp5 %>% dplyr::select(b=gid, name_b=name) %>% filter(!is.na(b) & !is.na(name_b) & name_b!='')  ) %>% dplyr::select(gid0=a, gid1=b, name1=name_b)  %>% distinct() 
          #mutate(name=paste0(name_a,"_",name_b)) %>% dplyr::select(gid, name) %>% distinct() %>% filter(!is.na(name) & name!='') #%>% filter(!duplicated(name))
dim(gadm1) #31362
#level1_distinct <- level1 %>% distinct() #no dupes

gadm2 <- gadm36_df %>% dplyr::select(gid=GID_2, a=GID_0, b=GID_1, c=GID_2) %>% filter(!is.na(a) & !is.na(b) & !is.na(c)) %>% 
          #left_join(temp5 %>% dplyr::select(a=gid, name_a=name) %>% filter(!is.na(a) & !is.na(name_a) & name_a!='')  ) %>% 
          left_join(temp5 %>% dplyr::select(c=gid, name=name) %>% filter(!is.na(c) & !is.na(name) & name!='')  ) %>% dplyr::select(gid0=a, gid1=b, gid2=c,  name2=name)  %>% distinct() 
          #mutate(name=paste0(name_a,"_",name_b)) %>% dplyr::select(gid, name) %>% distinct() %>% filter(!is.na(name) & name!='') #%>% filter(!duplicated(name))
dim(gadm2) #438,130
  

```

## Pull wikidata codes

```{r}

restartspark()

#Produce optimized versions of the file that are sorted, seperated, and more efficiently packed into fewer files

wikidata_labels_eng <- spark_read_parquet(sc=sc, name="wikidata_labels_eng", path='/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESSwikidata/data_out/wikidata_parq_optimized/level0=labels/level1=en', memory = F) 
replyr_nrow(wikidata_labels_eng) #48,936,919
head(wikidata_labels_eng) #

wikidata_aliases_eng <- spark_read_parquet(sc=sc, name="wikidata_alias_eng", path='/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESSwikidata/data_out/wikidata_parq_optimized/level0=aliases/level1=en', memory = F) 
replyr_nrow(wikidata_aliases_eng) #13,632,710
head(wikidata_aliases_eng) #

wikidata_aliaseslabels_eng <- rbind( #sparklyr actually prefers rbind
  wikidata_labels_eng %>% dplyr::select(wikidata_id,value),
  wikidata_aliases_eng %>% filter(level3=="value") %>% dplyr::select(wikidata_id,value)
)
replyr_nrow(wikidata_aliaseslabels_eng) #55,753,274

#If you are seeing this error in code that used to work, the most likely cause is a change dbplyr 1.4.0. Previously `df$x` or `df[[y]]` implied that `df` was a local variable, but now you must make that explict with `!!` or `local()`, e.g., `!!df$x`
#or `local(df[["y"]))
#geonames_admin0_qcodes <- wikidata_aliaseslabels_eng %>% mutate(value=tolower(value)) %>% mutate(value=regexp_replace(value," ","")) %>% filter(value %in% !!geonames_admin0$name ) 

claims_P31 <- spark_read_parquet(sc=sc, name="claims_P31", path="/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESSwikidata/data_out/wikidata_parq_optimized/level0=claims/level1=P31/level3=mainsnak",memory = F) %>% 
              filter(level6=="id")  %>% dplyr::select(wikidata_id, P31=value)
replyr_nrow(claims_P31) #60,824,711
test_texas <- claims_P31 %>% filter(wikidata_id=="Q1439") %>% collect()

#located in the administrative territorial entity (P131)
#country (Q6256)
#sovereign state (Q3624078)
#state with limited recognition (Q15634554)
#island nation (Q112099)
#British Overseas Territories (Q46395)
wikidata0 <- claims_P31 %>% filter(P31 %in% c('Q6256','Q3624078','Q15634554','Q112099','Q46395' )) %>% left_join(wikidata_aliaseslabels_eng) %>% dplyr::select(wikidata_id, value) %>% collect() %>% as.data.table()
dim(wikidata0)
temp <- wikidata0 %>% distinct() %>% count(value)

#hand drop dupes
#"Q58296","Q70802","Q161885","Q174193",
#As a good rule of thumb just pick the lowest nubmered one
library(stringi)
wikidata0_dt <- wikidata0 %>% distinct() %>% 
                         mutate(wikidata_id_numeric= str_replace(wikidata_id,"Q","") %>% as.numeric()) %>% 
                         mutate(name= value %>% rex_clean() ) %>% 
  
                         group_by(name) %>% filter(wikidata_id_numeric==min(wikidata_id_numeric)) %>% ungroup() %>%
                         dplyr::select(wikidata_id,name) %>% distinct() %>% mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character)  %>%
                         filter(!is.na(name) & name!='')
dim(wikidata0_dt) #1,877
test <- wikidata0_dt %>% count(name)

#wikidata1
#first-level administrative country subdivision (Q10864048)
#state of the United States (Q35657)

claims_P279 <- spark_read_parquet(sc=sc, name="claims_P279", path="/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESSwikidata/data_out/wikidata_parq_optimized/level0=claims/level1=P279/level3=mainsnak",memory = F) %>% 
               filter(level6=="id") %>% dplyr::select(wikidata_id, P279=value) 
test_Q10864048 <-  claims_P279 %>% filter(P279=="Q10864048") %>% collect()

claims_P279_Q10864048 <- claims_P279 %>% filter(P279=="Q10864048") # %>% collect() 

claims_P279_Q10864048 <- claims_P279 %>% filter(P279=="Q10864048") # %>% collect() 
claims_P279_Q10864048_subclasses <- claims_P279 %>% inner_join(claims_P279_Q10864048 %>% dplyr::select(P279=wikidata_id))
subclasses1 <- rbind(claims_P279_Q10864048, claims_P279_Q10864048_subclasses) %>% distinct()

#Republic of Serbia (Q934644)
test_Q934644 <- claims_P31 %>% filter(P31=="Q934644")
#state of the United States (Q35657)
test_Q35657 <- claims_P31 %>% filter(P31=="Q35657") %>% collect()

wikidata1 <- claims_P31 %>% inner_join(subclasses1 %>% dplyr::select(P31=wikidata_id)) %>% distinct() %>% left_join(wikidata_aliaseslabels_eng) %>% dplyr::select(wikidata_id, name1=value)  %>% collect() %>% as.data.table()
#replyr_nrow(wikidata1)
wikidata1_dt <- wikidata1  %>%
                mutate(name1= name1 %>% rex_clean() ) %>%               
                distinct() %>%
                filter(!is.na(name1) & name1!='')
dim(wikidata1_dt) #7,907 #7,095
#temp <- wikidata1 %>% distinct() %>% count(value)

#wikidata2
#county-equivalent (Q1188782)
#county or county-equivalent (Q13360155)
#second-level administrative country subdivision (Q13220204)
claims_P279_Q13220204 <- claims_P279 %>% filter(P279=="Q13220204") # %>% collect() 
replyr_nrow(claims_P279_Q13220204) #198
claims_P279_Q13220204_subclasses <- claims_P279 %>% inner_join(claims_P279_Q13220204 %>% dplyr::select(P279=wikidata_id)  %>% distinct())  %>% distinct()
replyr_nrow(claims_P279_Q13220204_subclasses) #198
subclasses2 <- rbind(claims_P279_Q13220204, claims_P279_Q13220204_subclasses) %>% distinct()
replyr_nrow(subclasses2) #305

wikidata2 <- claims_P31 %>% inner_join(subclasses2 %>% dplyr::select(P31=wikidata_id)) %>% left_join(wikidata_aliaseslabels_eng) %>% dplyr::select(wikidata_id, name2=value)  %>% collect() %>% as.data.table()
#replyr_nrow(wikidata1)
wikidata2_dt <- wikidata2  %>%
                mutate(name2= name2 %>% rex_clean() ) %>%               
                distinct() %>%
                filter(!is.na(name2) & name2!='') %>%
                dplyr::select(wikidata_id2=wikidata_id,name2)
dim(wikidata2_dt) #59,929
#temp <- wikidata2 %>% distinct() %>% count(value)


#this turned out to not work very well, the 279 hiearchy is too rough
#wikidata1
#We need everything that's a first-level administrative country subdivision
#first-level administrative country subdivision (Q10864048)
#claims_P279 <- spark_read_parquet(sc=sc, name="claims", path="/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESSwikidata/data_out/wikidata_parq_optimized/level0=claims/level1=P279",memory = F) %>% 
#               filter(level6=="id")  %>% filter(level3=="mainsnak") %>% dplyr::select(wikidata_id, P279=value)
#claims_P279_Q10864048 <- claims_P279 %>% filter(P279 == 'Q10864048')
#wikidata1 <- claims_P31 %>% inner_join(claims_P279_Q10864048 %>% dplyr::select(P31=wikidata_id)) %>% left_join(wikidata_aliases_eng) %>% filter(level3=="value") %>% dplyr::select(wikidata_id, value) %>% collect() %>% as.data.table()
#wikidata1_dt <- wikidata1 %>% distinct() %>% 
#                 mutate(wikidata_id_numeric= str_replace(wikidata_id,"Q","") %>% as.numeric()) %>% 
#                 mutate(name= value %>% rex_clean() ) %>% 
#  
#                 group_by(name) %>% filter(wikidata_id_numeric==min(wikidata_id_numeric)) %>% ungroup() %>%
#                 dplyr::select(wikidata_id,name) %>% distinct()
#dim(wikidata1_dt)

#This pulls every entity with a geonames id and all the labels and aliases for them
#GeoNames ID (P1566)
claims_P1566 <- spark_read_parquet(sc=sc, name="claims_P1566", path="/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESSwikidata/data_out/wikidata_parq_optimized/level0=claims/level1=P1566/level3=mainsnak",memory = F) #%>% 
              #filter(level6=="value") %>% dplyr::select(wikidata_id, P1566=value)
replyr_nrow(claims_P1566) #3683698

#temp <- claims_P1566 %>% head(10000) %>% collect()

wikidata_togeonames <- claims_P1566 %>% dplyr::select(wikidata_id, geonames= value) %>% left_join(wikidata_aliaseslabels_eng) %>% collect() %>% as.data.table()
dim(wikidata_togeonames) #3,998,220
wikidata_togeonames_dt <- wikidata_togeonames  %>% distinct() %>% 
                           mutate(wikidata_id_numeric= str_replace(wikidata_id,"Q","") %>% as.numeric()) %>% 
                           mutate(name= value %>% rex_clean() ) %>% 
                           group_by(name) %>% filter(wikidata_id_numeric==min(wikidata_id_numeric)) %>% ungroup() %>%
                           dplyr::select(wikidata_id,geonames,name) %>% distinct() %>% mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character) 
dim(wikidata_togeonames_dt) #2,258,725 #227,663



#ISO 3166-1 alpha-2 code (P297) #nope we actually want the 2 digit code. god damn it.
#ISO 3166-1 alpha-3 code (P298) #we actually want the alpha code
#ISO 3166-1 numeric code (P299) #not the nmeric one here
claims_P297 <- spark_read_parquet(sc=sc, name="claims", path="/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESSwikidata/data_out/wikidata_parq_optimized/level0=claims/level1=P297/level3=mainsnak",memory = F) #%>% 
              #filter(level6=="value") %>% dplyr::select(wikidata_id, P1566=value)
replyr_nrow(claims_P297) #

wikidata_to_ISO31661 <- claims_P297 %>% dplyr::select(wikidata_id, ISO31661 = value) %>% left_join(wikidata_aliaseslabels_eng) %>% collect() %>% as.data.table()
wikidata_to_ISO31661_dt <- wikidata_to_ISO31661  %>% distinct() %>% 
                           mutate(wikidata_id_numeric= str_replace(wikidata_id,"Q","") %>% as.numeric()) %>% 
                           mutate(name= value %>% rex_clean() ) %>% 
                           group_by(name) %>% filter(wikidata_id_numeric==min(wikidata_id_numeric)) %>% ungroup() %>%
                           dplyr::select(wikidata_id,ISO31661,name) %>% distinct() %>% mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character) 
dim(wikidata_to_ISO31661_dt) #1455

#ISO 3166-2 code (P300)
claims_P300 <- spark_read_parquet(sc=sc, name="claims", path="/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESSwikidata/data_out/wikidata_parq_optimized/level0=claims/level1=P300/level3=mainsnak",memory = F) #%>% 
              #filter(level6=="value") %>% dplyr::select(wikidata_id, P1566=value)
replyr_nrow(claims_P300) #5474

#wikidata_aliases_eng %>% filter(wikidata_id=="Q13750") #for some reason label is missing
#wikidata_labels_eng %>% filter(wikidata_id=="Q13750") #nope I'm an idiot, I've only been joining on aliases alone

wikidata_to_ISO31662 <- claims_P300 %>% dplyr::select(wikidata_id, ISO31662 = value) %>% left_join(wikidata_aliaseslabels_eng) %>% collect() %>% as.data.table() #some of these labels are missing
wikidata_to_ISO31662_dt <- wikidata_to_ISO31662  %>% distinct() %>% 
                           mutate(wikidata_id_numeric= str_replace(wikidata_id,"Q","") %>% as.numeric()) %>% 
                           mutate(name= value %>% rex_clean() ) %>% 
                           group_by(name) %>% filter(wikidata_id_numeric==min(wikidata_id_numeric)) %>% ungroup() %>%
                           dplyr::select(wikidata_id,ISO31662,name) %>% distinct() %>%
                           mutate(ISO31661=substr(ISO31662,1,2)) %>% mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character) 
dim(wikidata_to_ISO31662_dt) #8989

#

```

## Geonames

```{r}


library(data.table)
geonames <- fread("/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESScovid19/data_temp/allCountries.txt", sep="\t") %>% mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character)
dim(geonames) #12,006,426

#geonameid         : integer id of record in geonames database
#name              : name of geographical point (utf8) varchar(200)
#asciiname         : name of geographical point in plain ascii characters, varchar(200)
#alternatenames    : alternatenames, comma separated, ascii names automatically transliterated, convenience attribute from alternatename table, varchar(10000)
#latitude          : latitude in decimal degrees (wgs84)
#longitude         : longitude in decimal degrees (wgs84)
#feature class     : see http://www.geonames.org/export/codes.html, char(1)
#feature code      : see http://www.geonames.org/export/codes.html, varchar(10)
#country code      : ISO-3166 2-letter country code, 2 characters
#cc2               : alternate country codes, comma separated, ISO-3166 2-letter country code, 200 characters
#admin1 code       : fipscode (subject to change to iso code), see exceptions below, see file admin1Codes.txt for display names of this code; varchar(20)
#admin2 code       : code for the second administrative division, a county in the US, see file admin2Codes.txt; varchar(80) 
#admin3 code       : code for third level administrative division, varchar(20)
#admin4 code       : code for fourth level administrative division, varchar(20)
#population        : bigint (8 byte int) 
#elevation         : in meters, integer
#dem               : digital elevation model, srtm3 or gtopo30, average elevation of 3''x3'' (ca 90mx90m) or 30''x30'' (ca 900mx900m) area in meters, integer. srtm processed by cgiar/ciat.
#timezone          : the iana timezone id (see file timeZone.txt) varchar(40)
#modification date : date of last modification in yyyy-MM-dd format

vars <- c('geonameid','name','asciiname','alternatenames','latitude','longitude','feature_class','feature_code','country_code','cc2','admin1','admin2','admin3','admin4','population','elevation','dem','timezone','modification')
names(geonames) <- vars

test <- geonames %>% filter(name %in% "San Antonio") 

table(geonames$feature_class) %>% sort()
table(geonames$feature_code) %>% sort()


#hierachy is missing some, like san antonio for some reason 4726206
#let's add them back in
hierarchy <- fread("/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESScovid19/data_temp/hierarchy.txt", sep="\t")

#add these nestings
#unitedkingdom	 england
#unitedkingdom	 northernireland
#unitedkingdom	 scotland
#unitedkingdom	 wales
hierarchy <- rbindlist(list(hierarchy,
data.table(V1=2635167, V2=6269131),
data.table(V1=2635167, V2=2641364),
data.table(V1=2635167,V2=2638360),
data.table(V1=2635167,V2=2634895)
), fill=T)

dim(hierarchy) #488,103
library(igraph)
library(tictoc)
#vec <- 1:100000 #100k to 66 seconds whole thing is only 488k so this is fine. Nope apparently it's much longer than that for the full graph. Lots of branching nodes.
#1552.91 sec elapsed #took about 25 minutes
vec <- 1:nrow(hierarchy) #1:100000#
g <- graph.data.frame(hierarchy[vec,c(2,1)], #from and to so invert the columns
                 directed=TRUE, vertices=NULL)
#The root should be 6295630
#reachable
earth = V(g)[name=="6295630"]
#g_all <- subcomponent(g,
#             v=earth,
#             mode = c("in"))

#Could have also just done a bunch of joins. Probably would have been better.
path <- "/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESScovid19/data_temp/geonames_hierarchy_paths.txt"
fromscratch=F
if(fromscratch){
  tic()
  #shortest <- get.shortest.paths(graph=g,
  #                               from=earth,
  #                               mode = "in") #this is going to be really big
  all_shortest_paths <- get.shortest.paths(graph=g, #switching to all shortest paths to allow for multiple routes, e.g. england as a country or a admin1 under the UK
                                 from=earth,
                                 mode = "in") #this is going to be really big
  toc()
  saveRDS(all_shortest_paths,"/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESScovid19/data_temp/geonames_shortest_path.rds")

  all_shortest_paths <- readRDS("/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESScovid19/data_temp/geonames_shortest_path.rds")
  class(shortest)
  length(shortest) #516,803
  length(shortest[[1]])
  shortest[[1]][[1]]
  
  #we can iterate over this and just write them to a file and read back
  #This is slow, I don't care I just need this done right now
  tic()
  list_of_df <- lapply(vec, FUN=function(i)  data.frame( t(names(all_shortest_paths[[1]][[i]]) ))) #it still takes a while
  geonames_hierarchy_paths <- rbindlist(list_of_df, fill=T)
  toc() #only 4 minutes
  saveRDS(geonames_hierarchy_paths,"/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESScovid19/data_temp/geonames_hierarchy_paths.rds")
}

geonames_hierarchy_paths <- readRDS("/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESScovid19/data_temp/geonames_hierarchy_paths.rds") %>%
  mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character)

geonames_inpaths <- unique(c(hierarchy$V1,hierarchy$V2)) # length(geonames_inpaths) #516,803

#The table 'alternate names' :
#-----------------------------
#alternateNameId   : the id of this alternate name, int
#geonameid         : geonameId referring to id in table 'geoname', int
#isolanguage       : iso 639 language code 2- or 3-characters; 4-characters 'post' for postal codes and 'iata','icao' and faac for airport codes, fr_1793 for French Revolution names,  abbr for abbreviation, link to a website (mostly to #wikipedia), wkdt for the wikidataid, varchar(7)
#alternate name    : alternate name or name variant, varchar(400)
#isPreferredName   : '1', if this alternate name is an official/preferred name
#isShortName       : '1', if this is a short name like 'California' for 'State of California'
#isColloquial      : '1', if this alternate name is a colloquial or slang term. Example: 'Big Apple' for 'New York'.
#isHistoric        : '1', if this alternate name is historic and was used in the past. Example 'Bombay' for 'Mumbai'.
#from		  : from period when the name was used
#to		  : to period when the name was used
alternateNamesV2 <- fread("/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESScovid19/data_temp/alternateNamesV2/alternateNamesV2.txt", sep="\t") %>%
  mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character)
dim(alternateNamesV2) #14,984,570
table(alternateNamesV2$V3)
alternateNamesV2_eng <- alternateNamesV2 %>% dplyr::select(geonameid=V2,name=V4, lang=V3)  %>% dplyr::filter(lang %in% c('','en')) %>% dplyr::filter(geonameid %in% geonames_inpaths) #,'link'
dim(alternateNamesV2_eng) #479,596
alternateNamesV2_enwiki <- alternateNamesV2 %>% 
                            dplyr::select(geonameid=V2,enwiki=V4, lang=V3)  %>% 
                            dplyr::filter(lang %in% c('link')) %>% dplyr::filter(geonameid %in% geonames_inpaths) %>% 
                            filter(str_detect(enwiki, "https://en.wikipedia.org")) %>%
                            mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character)

#now rexclean
library(stringi)
rex_clean <- function(x){ x %>% stri_trans_general("latin-ascii") %>% stri_replace_all(regex="[^A-Za-z0-9]","") %>% tolower() } #so individually, each string should be devoid of spaces,noncharacters, and nonlatin

tic()
geonames_idtoname <- bind_rows(
  geonames %>% dplyr::select(geonameid,name) %>% filter(geonameid %in% geonames_inpaths) %>% mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character),
  geonames %>% dplyr::select(geonameid,name=asciiname) %>% filter(geonameid %in% geonames_inpaths) %>% mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character),
  #We can start small with just the regular names and then go back and add these
  alternateNamesV2_eng %>% dplyr::select(geonameid,name) %>% filter(geonameid %in% geonames_inpaths)  %>% mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character)
) %>% 
    mutate(name  = rex_clean(name)) %>% #this is what's expensive 
    mutate(name = trimws(name)) %>%
    filter(!is.na(name) & name!='') %>%
    distinct() %>%
  left_join(geonames %>% dplyr::select(geonameid,feature_code) %>% mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character) ) %>% 
  filter(!feature_code %in% c('HTL','BLDG','AIRP','SEA','HSE')) %>%
  mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character)
toc()

dim(geonames_idtoname) #605,632    

#Let's do admin0 first
#this adds wikidata codes to geonames codes
geonames_admin0 <- geonames_hierarchy_paths %>% dplyr::select(geonameid=X3) %>% distinct() %>% na.omit() %>% mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character) %>%
                   left_join(geonames_idtoname) %>% 
                   left_join(alternateNamesV2_enwiki %>% dplyr::select(-lang)) %>% distinct() %>% 
                   mutate(geonameid=as.character(geonameid)) %>%
                   left_join(wikidata_togeonames_dt %>% dplyr::select(geonameid=geonames, wikidata_id) ) %>% distinct() 
#this grabs extra labels and aliases
geonames_admin0 <- bind_rows(
  geonames_admin0,
  wikidata_togeonames_dt %>% dplyr::select(geonameid=geonames, wikidata_id, name) %>% inner_join(geonames_admin0 %>% dplyr::select(geonameid) %>% distinct())
) %>% distinct() %>% #I don't know why we ended up with dupes again but again pick the one with the lowest q code
  mutate(wikidata_id_numeric= str_replace(wikidata_id,"Q","") %>% as.numeric()) %>% 
   group_by(name) %>% filter(wikidata_id_numeric==min(wikidata_id_numeric)) %>% ungroup() %>% 
   arrange(geonameid,feature_code) %>% group_by(geonameid ) %>% fill(feature_code) %>% ungroup() %>% #fill down feature code
   dplyr::select(-wikidata_id_numeric) %>% distinct()

test <- geonames_admin0 %>% count(name) #ok no dupes now. every name is matched once and only once

geonames_admin1 <- geonames_hierarchy_paths %>% dplyr::select(geonameid0=X3, geonameid1=X4) %>% distinct() %>% na.omit() %>%
                   left_join(geonames_idtoname %>% dplyr::select(geonameid1=geonameid,name1=name, feature_code1=feature_code)) %>% distinct() %>%  arrange(geonameid0,geonameid1, name1) %>% mutate_if(is.numeric, as.character) %>%
                   left_join(geonames_admin0 %>% dplyr::select(geonameid0=geonameid,wikidata_id0=wikidata_id)) %>%
                   left_join(wikidata_togeonames_dt %>% dplyr::select(geonameid1=geonames, wikidata_id1=wikidata_id) ) %>% distinct() 
geonames_admin1 <- bind_rows(
  geonames_admin1,
  wikidata_togeonames_dt %>% dplyr::select(geonameid1=geonames, wikidata_id1=wikidata_id, name1=name) %>% inner_join(geonames_admin1 %>% dplyr::select(geonameid1) %>% distinct())
) %>% distinct() %>% 
  
  #I don't know why we ended up with dupes again but again pick the one with the lowest q code

  mutate(wikidata_id0_numeric= str_replace(wikidata_id0,"Q","") %>% as.numeric())  %>% 
  group_by(geonameid0,name1) %>% filter(wikidata_id0_numeric==min(wikidata_id0_numeric)) %>% ungroup() %>% 
  dplyr::select(-wikidata_id0_numeric) %>% distinct()  %>%

  mutate(wikidata_id1_numeric= str_replace(wikidata_id1,"Q","") %>% as.numeric())  %>% 
  group_by(geonameid0,name1) %>% filter(wikidata_id1_numeric==min(wikidata_id1_numeric)) %>% ungroup() %>% 
  dplyr::select(-wikidata_id1_numeric) %>% distinct()

test <- geonames_admin1 %>% count(geonameid0,name1) #ok no dupes now. every name is matched once and only once


geonames_admin2 <- geonames_hierarchy_paths %>% dplyr::select(geonameid0=X3, geonameid1=X4, geonameid2=X5) %>% distinct() %>% na.omit() %>%
                   left_join(geonames_idtoname %>% dplyr::select(geonameid2=geonameid,name2=name, feature_code2=feature_code)) %>% distinct() %>%  arrange(geonameid0,geonameid1,geonameid2, name2) %>%
                   left_join(geonames_admin1 %>% dplyr::select(-name1, -feature_code1)) %>%
                   left_join(wikidata_togeonames_dt %>% dplyr::select(geonameid2=geonames, wikidata_id2=wikidata_id) ) %>% distinct() 

```


## Combine countries, geonames, and admin into one admin0

```{r}

#devtools::install_github("moodymudskipper/safejoin")
library(safejoin)
#temp2 <- alternateNamesV2_enwiki %>% count(geonameid)

#gadm36_df = st_read("/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESSgadm/data_in/gadm36_gpkg/gadm36.gpkg") %>% as.data.frame()
#gadm36_admin0 <- gadm36_df %>% dplyr::select(gadm36=GID_0, name=NAME_0 ) %>% distinct() %>% mutate(name  = rex_clean(name))
#  
geonames_admin0 <- geonames_hierarchy_paths %>% dplyr::select(geonameid=X3) %>% distinct() %>% na.omit() %>% left_join(geonames_idtoname) %>% 
                   arrange(geonameid, name)  %>% distinct() %>% na.omit()  
##https://stackoverflow.com/questions/2547402/is-there-a-built-in-function-for-finding-the-mode
Mode <- function(x, na.rm = FALSE) {
  if(na.rm){
    x = x[!is.na(x)]
  }

  ux <- unique(x)
  return(ux[which.max(tabulate(match(x, ux)))])
}

admin0 <- geonames_admin0 %>% distinct() %>%
          safe_full_join(wikidata0_dt %>% distinct(), conflict=coalesce ) %>% distinct() %>%  #This pads it out to any that didn't get wikidata codes the first time 
          safe_full_join(countries_df_unique , conflict=coalesce ) %>% distinct() %>% 
          safe_full_join(wikidata_to_ISO31661_dt %>% dplyr::select(ISO31661,name), conflict=coalesce  ) %>% distinct() %>%
          safe_full_join(wikidata_to_ISO31661_dt %>% dplyr::select(wikidata_id,name), conflict=coalesce  ) %>% distinct() %>% #This pads it out to any that didn't get wikidata codes the first time 
          mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character) %>%
  
          safe_left_join(wikidata_togeonames_dt %>% dplyr::select(geonameid=geonames, wikidata_id=wikidata_id), by="wikidata_id", conflict = coalesce ) %>% distinct() %>%
          mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character) %>%
  
          safe_left_join(wikidata_togeonames_dt %>% dplyr::select(geonameid=geonames, wikidata_id=wikidata_id), by="geonameid", conflict = coalesce ) %>% distinct() %>%
          mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character) %>%
  
          #gid
          arrange(gid,geonameid)    %>% group_by(gid) %>% mutate(temp=geonameid)    %>% fill(temp) %>% mutate(geonameid=ifelse(!is.na(gid), temp, geonameid)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid,wikidata_id)  %>% group_by(gid) %>% mutate(temp=wikidata_id)  %>% fill(temp) %>% mutate(wikidata_id=ifelse(!is.na(gid), temp, wikidata_id)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid,ISO31661)     %>% group_by(gid) %>% mutate(temp=ISO31661)     %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(gid), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid,feature_code) %>% group_by(gid) %>% mutate(temp=feature_code) %>% fill(temp) %>% mutate(feature_code=ifelse(!is.na(gid), temp, feature_code)) %>% dplyr::select(-temp) %>% ungroup() %>%

          #geoname
          arrange(geonameid,gid)         %>% group_by(geonameid) %>% mutate(temp=gid) %>% fill(temp) %>% mutate(gid=ifelse(!is.na(geonameid), temp, gid)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid,wikidata_id) %>% group_by(geonameid) %>% mutate(temp=wikidata_id) %>% fill(temp) %>% mutate(wikidata_id=ifelse(!is.na(geonameid), temp, wikidata_id)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid,ISO31661)    %>% group_by(geonameid) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(geonameid), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid,feature_code)%>% group_by(geonameid) %>% mutate(temp=feature_code) %>% fill(temp) %>% mutate(feature_code=ifelse(!is.na(geonameid), temp, feature_code)) %>% dplyr::select(-temp) %>% ungroup() %>%

          #wikidata_id
          arrange(wikidata_id,gid)         %>% group_by(wikidata_id) %>% mutate(temp=gid)         %>% fill(temp) %>% mutate(gid=ifelse(!is.na(wikidata_id), temp, gid)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id,ISO31661)    %>% group_by(wikidata_id) %>% mutate(temp=ISO31661)    %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(wikidata_id), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id,feature_code)%>% group_by(wikidata_id) %>% mutate(temp=feature_code)%>% fill(temp) %>% mutate(feature_code=ifelse(!is.na(wikidata_id), temp, feature_code)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id,geonameid)   %>% group_by(wikidata_id) %>% mutate(temp=geonameid)   %>% fill(temp) %>% mutate(geonameid=ifelse(!is.na(wikidata_id), temp, geonameid)) %>% dplyr::select(-temp) %>% ungroup() %>%

          #wikidata_id
          arrange(ISO31661,gid)         %>% group_by(ISO31661) %>% mutate(temp=gid)         %>% fill(temp) %>% mutate(gid=ifelse(!is.na(ISO31661), temp, gid)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31661,wikidata_id)    %>% group_by(ISO31661) %>% mutate(temp=wikidata_id)    %>% fill(temp) %>% mutate(wikidata_id=ifelse(!is.na(ISO31661), temp, wikidata_id)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31661,feature_code)%>% group_by(ISO31661) %>% mutate(temp=feature_code)%>% fill(temp) %>% mutate(feature_code=ifelse(!is.na(ISO31661), temp, feature_code)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31661,geonameid)   %>% group_by(ISO31661) %>% mutate(temp=geonameid)   %>% fill(temp) %>% mutate(geonameid=ifelse(!is.na(ISO31661), temp, geonameid)) %>% dplyr::select(-temp) %>% ungroup() %>%
          
          #Round2
          #gid
          arrange(gid,geonameid)    %>% group_by(gid) %>% mutate(temp=geonameid)    %>% fill(temp) %>% mutate(geonameid=ifelse(!is.na(gid), temp, geonameid)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid,wikidata_id)  %>% group_by(gid) %>% mutate(temp=wikidata_id)  %>% fill(temp) %>% mutate(wikidata_id=ifelse(!is.na(gid), temp, wikidata_id)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid,ISO31661)     %>% group_by(gid) %>% mutate(temp=ISO31661)     %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(gid), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid,feature_code) %>% group_by(gid) %>% mutate(temp=feature_code) %>% fill(temp) %>% mutate(feature_code=ifelse(!is.na(gid), temp, feature_code)) %>% dplyr::select(-temp) %>% ungroup() %>%

          #geoname
          arrange(geonameid,gid)         %>% group_by(geonameid) %>% mutate(temp=gid) %>% fill(temp) %>% mutate(gid=ifelse(!is.na(geonameid), temp, gid)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid,wikidata_id) %>% group_by(geonameid) %>% mutate(temp=wikidata_id) %>% fill(temp) %>% mutate(wikidata_id=ifelse(!is.na(geonameid), temp, wikidata_id)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid,ISO31661)    %>% group_by(geonameid) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(geonameid), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid,feature_code)%>% group_by(geonameid) %>% mutate(temp=feature_code) %>% fill(temp) %>% mutate(feature_code=ifelse(!is.na(geonameid), temp, feature_code)) %>% dplyr::select(-temp) %>% ungroup() %>%

          #wikidata_id
          arrange(wikidata_id,gid)         %>% group_by(wikidata_id) %>% mutate(temp=gid)         %>% fill(temp) %>% mutate(gid=ifelse(!is.na(wikidata_id), temp, gid)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id,ISO31661)    %>% group_by(wikidata_id) %>% mutate(temp=ISO31661)    %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(wikidata_id), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id,feature_code)%>% group_by(wikidata_id) %>% mutate(temp=feature_code)%>% fill(temp) %>% mutate(feature_code=ifelse(!is.na(wikidata_id), temp, feature_code)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id,geonameid)   %>% group_by(wikidata_id) %>% mutate(temp=geonameid)   %>% fill(temp) %>% mutate(geonameid=ifelse(!is.na(wikidata_id), temp, geonameid)) %>% dplyr::select(-temp) %>% ungroup() %>%

          #wikidata_id
          arrange(ISO31661,gid)         %>% group_by(ISO31661) %>% mutate(temp=gid)         %>% fill(temp) %>% mutate(gid=ifelse(!is.na(ISO31661), temp, gid)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31661,wikidata_id)    %>% group_by(ISO31661) %>% mutate(temp=wikidata_id)    %>% fill(temp) %>% mutate(wikidata_id=ifelse(!is.na(ISO31661), temp, wikidata_id)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31661,feature_code)%>% group_by(ISO31661) %>% mutate(temp=feature_code)%>% fill(temp) %>% mutate(feature_code=ifelse(!is.na(ISO31661), temp, feature_code)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31661,geonameid)   %>% group_by(ISO31661) %>% mutate(temp=geonameid)   %>% fill(temp) %>% mutate(geonameid=ifelse(!is.na(ISO31661), temp, geonameid)) %>% dplyr::select(-temp) %>% ungroup() %>%  
    
          mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character) %>%
          rename(admin0_name_clean=name , geonameid0=geonameid , feature_code0=feature_code,wikidata_id0=wikidata_id,  gid0=gid) %>%
          distinct() %>% 
          filter(!is.na(geonameid0)) %>% # everything that's missing a geoname is a historical entitty we don't want anyway
          filter(!is.na(wikidata_id0)) %>%
          
          #if more than one q code, pick the smallsest
          mutate(wikidata_id0_numeric= str_replace(wikidata_id0,"Q","") %>% as.numeric())  %>% 
          group_by(admin0_name_clean) %>% filter(wikidata_id0_numeric==min(wikidata_id0_numeric)) %>% ungroup() %>% 
          dplyr::select(-wikidata_id0_numeric) %>% distinct() %>%
  
          group_by(wikidata_id0) %>%
          mutate(geonameid0=  Mode(geonameid0, na.rm = T)) %>% #there's a couple of dupes, replace it with the modal value by qcode
          mutate(feature_code0= Mode(feature_code0, na.rm = T) ) %>% #there's a couple of dupes, replace it with the modal value by qcode
          mutate(gid0= Mode(gid0, na.rm = T) ) %>% #there's a couple of dupes, replace it with the modal value by qcode
          mutate(ISO31661= Mode(ISO31661, na.rm = T) ) %>% #there's a couple of dupes, replace it with the modal value by qcode
          ungroup() %>% 
          distinct() %>%
          filter(!is.na(admin0_name_clean) & admin0_name_clean!='')

dim(admin0) #15,954 #15,833
sapply(admin0, function(x) sum(is.na(x)))
test <- admin0 %>% count(admin0_name_clean)


#wikidata on admin1 is a mess so we're joining on geonames code instead
admin1 <- admin0 %>% dplyr::select(-admin0_name_clean,-feature_code0) %>% distinct() %>% mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character) %>%

          safe_full_join(geonames_admin1 %>% distinct() %>% filter(!is.na(name1))  , conflict = coalesce, by="geonameid0"  )  %>% distinct() %>% mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character) %>%

          safe_full_join(gadm1 %>% distinct()  %>% filter(!is.na(name1)) , conflict = coalesce ) %>% distinct() %>% mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character) %>%

  
          safe_full_join(wikidata_to_ISO31662_dt %>% dplyr::select(wikidata_id1=wikidata_id, ISO31662, name1=name, ISO31661)  %>% distinct() %>% filter(!is.na(name1)) , conflict = coalesce  ) %>% distinct() %>%
          mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character) %>%

          #add q codes  
          safe_full_join(wikidata_togeonames_dt %>% dplyr::select(geonameid1=geonames, wikidata_id1=wikidata_id), by="geonameid1", conflict = coalesce ) %>% distinct() %>% filter(!is.na(name1)) %>% #from the geonames
          #this one is a full join
          safe_full_join(wikidata1_dt %>% group_by(name1) %>% mutate(n=n()) %>% ungroup() %>% filter(n==1) %>% dplyr::select(-n, wikidata_id1=wikidata_id, name1) , by="name1", conflict = coalesce ) %>% #from matched names from known admin1 levels

          #add geomanames
          safe_full_join(wikidata_togeonames_dt %>% dplyr::select(geonameid1=geonames, wikidata_id1=wikidata_id), by="wikidata_id1", conflict = coalesce ) %>% distinct() %>% filter(!is.na(name1)) %>%  #from wikidata codes

          safe_full_join(wikidata1_dt %>% distinct() %>% dplyr::select(wikidata_id1=wikidata_id, name1=name1), conflict = coalesce) %>% #throw in extra wikidata names last
    
          mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character) %>%

          #geonameid1
          arrange(geonameid1,geonameid0)          %>% group_by(geonameid1) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(geonameid1), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,wikidata_id0)        %>% group_by(geonameid1) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(geonameid1), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,wikidata_id1)        %>% group_by(geonameid1) %>% mutate(temp=wikidata_id1) %>% fill(temp) %>% mutate(wikidata_id1=ifelse(!is.na(geonameid1), temp, wikidata_id1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,ISO31661)            %>% group_by(geonameid1) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(geonameid1), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,ISO31662)            %>% group_by(geonameid1) %>% mutate(temp=ISO31662) %>% fill(temp) %>% mutate(ISO31662=ifelse(!is.na(geonameid1), temp, ISO31662)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,gid0)                %>% group_by(geonameid1) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(geonameid1), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,gid1)                %>% group_by(geonameid1) %>% mutate(temp=gid1) %>% fill(temp) %>% mutate(gid1=ifelse(!is.na(geonameid1), temp, gid1)) %>% dplyr::select(-temp) %>% ungroup() %>%  
  
          #wikidata_id1
          arrange(wikidata_id1,wikidata_id0)                %>% group_by(wikidata_id1) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(wikidata_id1), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,feature_code1)                %>% group_by(wikidata_id1) %>% mutate(temp=feature_code1) %>% fill(temp) %>% mutate(feature_code1=ifelse(!is.na(wikidata_id1), temp, feature_code1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,geonameid0)                %>% group_by(wikidata_id1) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(wikidata_id1), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,geonameid1)                %>% group_by(wikidata_id1) %>% mutate(temp=geonameid1) %>% fill(temp) %>% mutate(geonameid1=ifelse(!is.na(wikidata_id1), temp, geonameid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,ISO31661)                %>% group_by(wikidata_id1) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(wikidata_id1), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,ISO31662)                %>% group_by(wikidata_id1) %>% mutate(temp=ISO31662) %>% fill(temp) %>% mutate(ISO31662=ifelse(!is.na(wikidata_id1), temp, ISO31662)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,gid0)                %>% group_by(wikidata_id1) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(wikidata_id1), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,gid1)                %>% group_by(wikidata_id1) %>% mutate(temp=gid1) %>% fill(temp) %>% mutate(gid1=ifelse(!is.na(wikidata_id1), temp, gid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
    
          #Gid1
          arrange(gid1,gid0)                %>% group_by(gid1) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(gid1), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,geonameid0)                %>% group_by(gid1) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(gid1), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,geonameid1)                %>% group_by(gid1) %>% mutate(temp=geonameid1) %>% fill(temp) %>% mutate(geonameid1=ifelse(!is.na(gid1), temp, geonameid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,feature_code1)                %>% group_by(gid1) %>% mutate(temp=feature_code1) %>% fill(temp) %>% mutate(feature_code1=ifelse(!is.na(gid1), temp, feature_code1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,wikidata_id0)                %>% group_by(gid1) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(gid1), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,wikidata_id1)                %>% group_by(gid1) %>% mutate(temp=wikidata_id1) %>% fill(temp) %>% mutate(wikidata_id1=ifelse(!is.na(gid1), temp, wikidata_id1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,ISO31661)                %>% group_by(gid1) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(gid1), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,ISO31662)                %>% group_by(gid1) %>% mutate(temp=ISO31662) %>% fill(temp) %>% mutate(ISO31662=ifelse(!is.na(gid1), temp, ISO31662)) %>% dplyr::select(-temp) %>% ungroup() %>%

          #ISO31662
          arrange(ISO31662,ISO31661)                %>% group_by(ISO31662) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(ISO31662), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,geonameid0)                %>% group_by(ISO31662) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(ISO31662), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,geonameid1)                %>% group_by(ISO31662) %>% mutate(temp=geonameid1) %>% fill(temp) %>% mutate(geonameid1=ifelse(!is.na(ISO31662), temp, geonameid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,wikidata_id0)                %>% group_by(ISO31662) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(ISO31662), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,wikidata_id1)                %>% group_by(ISO31662) %>% mutate(temp=wikidata_id1) %>% fill(temp) %>% mutate(wikidata_id1=ifelse(!is.na(ISO31662), temp, wikidata_id1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,gid0)                %>% group_by(ISO31662) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(ISO31662), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,gid1)                %>% group_by(ISO31662) %>% mutate(temp=gid1) %>% fill(temp) %>% mutate(gid1=ifelse(!is.na(ISO31662), temp, gid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
  
          #level0 ones now
          #geonameid0
          arrange(geonameid0,wikidata_id0)        %>% group_by(geonameid0) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(geonameid0), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid0,ISO31661)            %>% group_by(geonameid0) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(geonameid0), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid0,gid0)                %>% group_by(geonameid0) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(geonameid0), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%

          #wikidata_id0
          arrange(wikidata_id0,geonameid0)                %>% group_by(wikidata_id0) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(wikidata_id0), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id0,ISO31661)                %>% group_by(wikidata_id0) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(wikidata_id0), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id0,gid0)                %>% group_by(wikidata_id0) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(wikidata_id0), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%

          #Gid0
          arrange(gid0,geonameid0)                %>% group_by(gid0) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(gid0), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid0,wikidata_id0)                %>% group_by(gid0) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(gid0), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid0,ISO31661)                %>% group_by(gid0) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(gid0), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%

          #ISO31661
          arrange(ISO31661,geonameid0)                %>% group_by(ISO31661) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(ISO31661), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31661,wikidata_id0)                %>% group_by(ISO31661) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(ISO31661), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31661,gid0)                %>% group_by(ISO31661) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(ISO31661), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          
          #gid0 has the fewest mising so it's our country grouping
          #some of these names are dupes and we can group by that now and go down
          filter(!is.na(name1)) %>% #make sure again that all the names are the
          arrange(gid0,name1,gid1)                %>% group_by(gid0,name1) %>% mutate(temp=gid1) %>% fill(temp)          %>% mutate(gid1=ifelse(!is.na(gid0), temp, gid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid0,name1,geonameid1)          %>% group_by(gid0,name1) %>% mutate(temp=geonameid1) %>% fill(temp)    %>% mutate(geonameid1=ifelse(!is.na(gid0), temp, geonameid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid0,name1,feature_code1)       %>% group_by(gid0,name1) %>% mutate(temp=feature_code1) %>% fill(temp) %>% mutate(feature_code1=ifelse(!is.na(gid0), temp, feature_code1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid0,name1,wikidata_id1)        %>% group_by(gid0,name1) %>% mutate(temp=wikidata_id1) %>% fill(temp)  %>% mutate(wikidata_id1=ifelse(!is.na(gid0), temp, wikidata_id1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid0,name1,ISO31662)            %>% group_by(gid0,name1) %>% mutate(temp=ISO31662) %>% fill(temp)      %>% mutate(ISO31662=ifelse(!is.na(gid0), temp, ISO31662)) %>% dplyr::select(-temp) %>% ungroup() %>%
  
  
          #second round of level1
          #geonameid1
          arrange(geonameid1,geonameid0)          %>% group_by(geonameid1) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(geonameid1), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,wikidata_id0)        %>% group_by(geonameid1) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(geonameid1), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,wikidata_id1)        %>% group_by(geonameid1) %>% mutate(temp=wikidata_id1) %>% fill(temp) %>% mutate(wikidata_id1=ifelse(!is.na(geonameid1), temp, wikidata_id1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,ISO31661)            %>% group_by(geonameid1) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(geonameid1), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,ISO31662)            %>% group_by(geonameid1) %>% mutate(temp=ISO31662) %>% fill(temp) %>% mutate(ISO31662=ifelse(!is.na(geonameid1), temp, ISO31662)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,gid0)                %>% group_by(geonameid1) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(geonameid1), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,gid1)                %>% group_by(geonameid1) %>% mutate(temp=gid1) %>% fill(temp) %>% mutate(gid1=ifelse(!is.na(geonameid1), temp, gid1)) %>% dplyr::select(-temp) %>% ungroup() %>%  
  
          #wikidata_id1
          arrange(wikidata_id1,wikidata_id0)                %>% group_by(wikidata_id1) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(wikidata_id1), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,feature_code1)                %>% group_by(wikidata_id1) %>% mutate(temp=feature_code1) %>% fill(temp) %>% mutate(feature_code1=ifelse(!is.na(wikidata_id1), temp, feature_code1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,geonameid0)                %>% group_by(wikidata_id1) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(wikidata_id1), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,geonameid1)                %>% group_by(wikidata_id1) %>% mutate(temp=geonameid1) %>% fill(temp) %>% mutate(geonameid1=ifelse(!is.na(wikidata_id1), temp, geonameid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,ISO31661)                %>% group_by(wikidata_id1) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(wikidata_id1), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,ISO31662)                %>% group_by(wikidata_id1) %>% mutate(temp=ISO31662) %>% fill(temp) %>% mutate(ISO31662=ifelse(!is.na(wikidata_id1), temp, ISO31662)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,gid0)                %>% group_by(wikidata_id1) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(wikidata_id1), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,gid1)                %>% group_by(wikidata_id1) %>% mutate(temp=gid1) %>% fill(temp) %>% mutate(gid1=ifelse(!is.na(wikidata_id1), temp, gid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
    
          #Gid1
          arrange(gid1,gid0)                %>% group_by(gid1) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(gid1), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,geonameid0)                %>% group_by(gid1) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(gid1), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,geonameid1)                %>% group_by(gid1) %>% mutate(temp=geonameid1) %>% fill(temp) %>% mutate(geonameid1=ifelse(!is.na(gid1), temp, geonameid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,feature_code1)                %>% group_by(gid1) %>% mutate(temp=feature_code1) %>% fill(temp) %>% mutate(feature_code1=ifelse(!is.na(gid1), temp, feature_code1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,wikidata_id0)                %>% group_by(gid1) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(gid1), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,wikidata_id1)                %>% group_by(gid1) %>% mutate(temp=wikidata_id1) %>% fill(temp) %>% mutate(wikidata_id1=ifelse(!is.na(gid1), temp, wikidata_id1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,ISO31661)                %>% group_by(gid1) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(gid1), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,ISO31662)                %>% group_by(gid1) %>% mutate(temp=ISO31662) %>% fill(temp) %>% mutate(ISO31662=ifelse(!is.na(gid1), temp, ISO31662)) %>% dplyr::select(-temp) %>% ungroup() %>%

          #ISO31662
          arrange(ISO31662,ISO31661)                %>% group_by(ISO31662) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(ISO31662), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,geonameid0)                %>% group_by(ISO31662) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(ISO31662), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,geonameid1)                %>% group_by(ISO31662) %>% mutate(temp=geonameid1) %>% fill(temp) %>% mutate(geonameid1=ifelse(!is.na(ISO31662), temp, geonameid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,wikidata_id0)                %>% group_by(ISO31662) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(ISO31662), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,wikidata_id1)                %>% group_by(ISO31662) %>% mutate(temp=wikidata_id1) %>% fill(temp) %>% mutate(wikidata_id1=ifelse(!is.na(ISO31662), temp, wikidata_id1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,gid0)                %>% group_by(ISO31662) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(ISO31662), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,gid1)                %>% group_by(ISO31662) %>% mutate(temp=gid1) %>% fill(temp) %>% mutate(gid1=ifelse(!is.na(ISO31662), temp, gid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
  
          rename(admin1_name_clean=name1) %>% distinct() %>%
          mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character)
dim(admin1) #47,313 
sapply(admin1, function(x) sum(is.na(x))) #we have wikidata id for all but 1674

admin2 <- admin1 %>% dplyr::select(-admin1_name_clean, -feature_code1) %>%
  
          safe_full_join(geonames_admin2 , conflict = coalesce) %>%
          safe_full_join(gadm2 , conflict = coalesce) %>% distinct() %>%

          #we can get back some geonames ids from their q codes that aren't in the geonames hierarchy correctly
          safe_left_join(wikidata_togeonames_dt %>% dplyr::select(geonameid1=geonames, wikidata_id1=wikidata_id), by="wikidata_id1", conflict = coalesce ) %>% distinct()  %>% 
          safe_left_join(wikidata_togeonames_dt %>% dplyr::select(geonameid1=geonames, wikidata_id1=wikidata_id), by="geonameid1", conflict = coalesce ) %>% distinct()  %>%
  
          #add wikidata codes by geoname or exact name match
          safe_left_join(wikidata_togeonames_dt %>% dplyr::select(geonameid2=geonames, wikidata_id2=wikidata_id), by="geonameid2", conflict = coalesce ) %>% distinct()  %>%
          #this one is a full join
          safe_full_join(wikidata2_dt %>% group_by(name2) %>% mutate(n=n()) %>% ungroup() %>% filter(n==1) %>% dplyr::select(-n) , by="name2", conflict = coalesce ) %>% distinct()  %>% #this adds a qcode for any admin2 names that appear only once

          #grab geoname back
          safe_left_join(wikidata_togeonames_dt %>% dplyr::select(geonameid2=geonames, wikidata_id2=wikidata_id), by="wikidata_id2", conflict = coalesce ) %>% distinct()  %>% 

          safe_full_join(wikidata2_dt %>% distinct() %>% dplyr::select(wikidata_id2=wikidata_id2, name2=name2), conflict = coalesce) %>% #throw in extra wikidata names last

          mutate_if(is.numeric,as.character) %>% mutate_if(is.factor,as.character) %>%

          filter(!is.na(name2) & name2!='') %>% distinct() %>%
  
          #geonameid1
          arrange(geonameid2,geonameid0)          %>% group_by(geonameid2) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(geonameid2), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid2,geonameid1)          %>% group_by(geonameid2) %>% mutate(temp=geonameid1) %>% fill(temp) %>% mutate(geonameid1=ifelse(!is.na(geonameid2), temp, geonameid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid2,feature_code2)          %>% group_by(geonameid2) %>% mutate(temp=feature_code2) %>% fill(temp) %>% mutate(feature_code2=ifelse(!is.na(geonameid2), temp, feature_code2)) %>% dplyr::select(-temp) %>% ungroup() %>%
  
          arrange(geonameid2,wikidata_id0)        %>% group_by(geonameid2) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(geonameid2), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid2,wikidata_id1)        %>% group_by(geonameid2) %>% mutate(temp=wikidata_id1) %>% fill(temp) %>% mutate(wikidata_id1=ifelse(!is.na(geonameid2), temp, wikidata_id1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid2,wikidata_id2)        %>% group_by(geonameid2) %>% mutate(temp=wikidata_id2) %>% fill(temp) %>% mutate(wikidata_id2=ifelse(!is.na(geonameid2), temp, wikidata_id2)) %>% dplyr::select(-temp) %>% ungroup() %>%
  
          arrange(geonameid2,ISO31661)            %>% group_by(geonameid2) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(geonameid2), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid2,ISO31662)            %>% group_by(geonameid2) %>% mutate(temp=ISO31662) %>% fill(temp) %>% mutate(ISO31662=ifelse(!is.na(geonameid2), temp, ISO31662)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid2,gid0)                %>% group_by(geonameid2) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(geonameid2), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid2,gid1)                %>% group_by(geonameid2) %>% mutate(temp=gid1) %>% fill(temp) %>% mutate(gid1=ifelse(!is.na(geonameid2), temp, gid1)) %>% dplyr::select(-temp) %>% ungroup() %>%  
          arrange(geonameid2,gid2)                %>% group_by(geonameid2) %>% mutate(temp=gid2) %>% fill(temp) %>% mutate(gid2=ifelse(!is.na(geonameid2), temp, gid2)) %>% dplyr::select(-temp) %>% ungroup() %>%  
  
  
          #wikidata_id1
          arrange(wikidata_id2,wikidata_id0)                %>% group_by(wikidata_id2) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(wikidata_id2), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id2,wikidata_id1)                %>% group_by(wikidata_id2) %>% mutate(temp=wikidata_id1) %>% fill(temp) %>% mutate(wikidata_id1=ifelse(!is.na(wikidata_id2), temp, wikidata_id1)) %>% dplyr::select(-temp) %>% ungroup() %>%
  
          arrange(wikidata_id2,feature_code2)                %>% group_by(wikidata_id2) %>% mutate(temp=feature_code2) %>% fill(temp) %>% mutate(feature_code2=ifelse(!is.na(wikidata_id2), temp, feature_code2)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id2,geonameid0)                %>% group_by(wikidata_id2) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(wikidata_id2), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id2,geonameid1)                %>% group_by(wikidata_id2) %>% mutate(temp=geonameid1) %>% fill(temp) %>% mutate(geonameid1=ifelse(!is.na(wikidata_id2), temp, geonameid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id2,geonameid2)                %>% group_by(wikidata_id2) %>% mutate(temp=geonameid2) %>% fill(temp) %>% mutate(geonameid2=ifelse(!is.na(wikidata_id2), temp, geonameid2)) %>% dplyr::select(-temp) %>% ungroup() %>%
  
          arrange(wikidata_id2,ISO31661)                %>% group_by(wikidata_id2) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(wikidata_id2), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id2,ISO31662)                %>% group_by(wikidata_id2) %>% mutate(temp=ISO31662) %>% fill(temp) %>% mutate(ISO31662=ifelse(!is.na(wikidata_id2), temp, ISO31662)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id2,gid0)                %>% group_by(wikidata_id2) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(wikidata_id2), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id2,gid1)                %>% group_by(wikidata_id2) %>% mutate(temp=gid1) %>% fill(temp) %>% mutate(gid1=ifelse(!is.na(wikidata_id2), temp, gid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id2,gid2)                %>% group_by(wikidata_id2) %>% mutate(temp=gid2) %>% fill(temp) %>% mutate(gid2=ifelse(!is.na(wikidata_id2), temp, gid2)) %>% dplyr::select(-temp) %>% ungroup() %>%

          #gid2
          arrange(gid2,gid0)                %>% group_by(gid2) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(gid2), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid2,gid1)                %>% group_by(gid2) %>% mutate(temp=gid1) %>% fill(temp) %>% mutate(gid1=ifelse(!is.na(gid2), temp, gid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
  
          arrange(gid2,geonameid0)                %>% group_by(gid2) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(gid2), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid2,geonameid1)                %>% group_by(gid2) %>% mutate(temp=geonameid1) %>% fill(temp) %>% mutate(geonameid1=ifelse(!is.na(gid2), temp, geonameid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid2,geonameid2)                %>% group_by(gid2) %>% mutate(temp=geonameid2) %>% fill(temp) %>% mutate(geonameid2=ifelse(!is.na(gid2), temp, geonameid2)) %>% dplyr::select(-temp) %>% ungroup() %>%
          
          arrange(gid2,feature_code2)                %>% group_by(gid2) %>% mutate(temp=feature_code2) %>% fill(temp) %>% mutate(feature_code2=ifelse(!is.na(gid2), temp, feature_code2)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid2,wikidata_id0)                %>% group_by(gid2) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(gid2), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid2,wikidata_id1)                %>% group_by(gid2) %>% mutate(temp=wikidata_id1) %>% fill(temp) %>% mutate(wikidata_id1=ifelse(!is.na(gid2), temp, wikidata_id1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid2,wikidata_id2)                %>% group_by(gid2) %>% mutate(temp=wikidata_id2) %>% fill(temp) %>% mutate(wikidata_id2=ifelse(!is.na(gid2), temp, wikidata_id2)) %>% dplyr::select(-temp) %>% ungroup() %>%
  
          arrange(gid2,ISO31661)                %>% group_by(gid2) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(gid2), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid2,ISO31662)                %>% group_by(gid2) %>% mutate(temp=ISO31662) %>% fill(temp) %>% mutate(ISO31662=ifelse(!is.na(gid2), temp, ISO31662)) %>% dplyr::select(-temp) %>% ungroup() %>%  
  
  
          #geonameid1
          arrange(geonameid1,geonameid0)          %>% group_by(geonameid1) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(geonameid1), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,wikidata_id0)        %>% group_by(geonameid1) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(geonameid1), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,wikidata_id1)        %>% group_by(geonameid1) %>% mutate(temp=wikidata_id1) %>% fill(temp) %>% mutate(wikidata_id1=ifelse(!is.na(geonameid1), temp, wikidata_id1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,ISO31661)            %>% group_by(geonameid1) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(geonameid1), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,ISO31662)            %>% group_by(geonameid1) %>% mutate(temp=ISO31662) %>% fill(temp) %>% mutate(ISO31662=ifelse(!is.na(geonameid1), temp, ISO31662)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,gid0)                %>% group_by(geonameid1) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(geonameid1), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid1,gid1)                %>% group_by(geonameid1) %>% mutate(temp=gid1) %>% fill(temp) %>% mutate(gid1=ifelse(!is.na(geonameid1), temp, gid1)) %>% dplyr::select(-temp) %>% ungroup() %>%  
  
          #wikidata_id1
          arrange(wikidata_id1,wikidata_id0)                %>% group_by(wikidata_id1) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(wikidata_id1), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,geonameid0)                %>% group_by(wikidata_id1) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(wikidata_id1), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,geonameid1)                %>% group_by(wikidata_id1) %>% mutate(temp=geonameid1) %>% fill(temp) %>% mutate(geonameid1=ifelse(!is.na(wikidata_id1), temp, geonameid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,ISO31661)                %>% group_by(wikidata_id1) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(wikidata_id1), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,ISO31662)                %>% group_by(wikidata_id1) %>% mutate(temp=ISO31662) %>% fill(temp) %>% mutate(ISO31662=ifelse(!is.na(wikidata_id1), temp, ISO31662)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,gid0)                %>% group_by(wikidata_id1) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(wikidata_id1), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id1,gid1)                %>% group_by(wikidata_id1) %>% mutate(temp=gid1) %>% fill(temp) %>% mutate(gid1=ifelse(!is.na(wikidata_id1), temp, gid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
    
          #Gid1
          arrange(gid1,gid0)                %>% group_by(gid1) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(gid1), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,geonameid0)                %>% group_by(gid1) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(gid1), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,geonameid1)                %>% group_by(gid1) %>% mutate(temp=geonameid1) %>% fill(temp) %>% mutate(geonameid1=ifelse(!is.na(gid1), temp, geonameid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,wikidata_id0)                %>% group_by(gid1) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(gid1), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,wikidata_id1)                %>% group_by(gid1) %>% mutate(temp=wikidata_id1) %>% fill(temp) %>% mutate(wikidata_id1=ifelse(!is.na(gid1), temp, wikidata_id1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,ISO31661)                %>% group_by(gid1) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(gid1), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid1,ISO31662)                %>% group_by(gid1) %>% mutate(temp=ISO31662) %>% fill(temp) %>% mutate(ISO31662=ifelse(!is.na(gid1), temp, ISO31662)) %>% dplyr::select(-temp) %>% ungroup() %>%

          #ISO31662
          arrange(ISO31662,ISO31661)                %>% group_by(ISO31662) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(ISO31662), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,geonameid0)                %>% group_by(ISO31662) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(ISO31662), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,geonameid1)                %>% group_by(ISO31662) %>% mutate(temp=geonameid1) %>% fill(temp) %>% mutate(geonameid1=ifelse(!is.na(ISO31662), temp, geonameid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,wikidata_id0)                %>% group_by(ISO31662) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(ISO31662), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,wikidata_id1)                %>% group_by(ISO31662) %>% mutate(temp=wikidata_id1) %>% fill(temp) %>% mutate(wikidata_id1=ifelse(!is.na(ISO31662), temp, wikidata_id1)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,gid0)                %>% group_by(ISO31662) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(ISO31662), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31662,gid1)                %>% group_by(ISO31662) %>% mutate(temp=gid1) %>% fill(temp) %>% mutate(gid1=ifelse(!is.na(ISO31662), temp, gid1)) %>% dplyr::select(-temp) %>% ungroup() %>%
  
          #level0 ones now
          #geonameid0
          arrange(geonameid0,wikidata_id0)        %>% group_by(geonameid0) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(geonameid0), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid0,ISO31661)            %>% group_by(geonameid0) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(geonameid0), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(geonameid0,gid0)                %>% group_by(geonameid0) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(geonameid0), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%

          #wikidata_id0
          arrange(wikidata_id0,geonameid0)                %>% group_by(wikidata_id0) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(wikidata_id0), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id0,ISO31661)                %>% group_by(wikidata_id0) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(wikidata_id0), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(wikidata_id0,gid0)                %>% group_by(wikidata_id0) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(wikidata_id0), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%

          #Gid0
          arrange(gid0,geonameid0)                %>% group_by(gid0) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(gid0), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid0,wikidata_id0)                %>% group_by(gid0) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(gid0), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid0,ISO31661)                %>% group_by(gid0) %>% mutate(temp=ISO31661) %>% fill(temp) %>% mutate(ISO31661=ifelse(!is.na(gid0), temp, ISO31661)) %>% dplyr::select(-temp) %>% ungroup() %>%

          #ISO31661
          arrange(ISO31661,geonameid0)                %>% group_by(ISO31661) %>% mutate(temp=geonameid0) %>% fill(temp) %>% mutate(geonameid0=ifelse(!is.na(ISO31661), temp, geonameid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31661,wikidata_id0)                %>% group_by(ISO31661) %>% mutate(temp=wikidata_id0) %>% fill(temp) %>% mutate(wikidata_id0=ifelse(!is.na(ISO31661), temp, wikidata_id0)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(ISO31661,gid0)                %>% group_by(ISO31661) %>% mutate(temp=gid0) %>% fill(temp) %>% mutate(gid0=ifelse(!is.na(ISO31661), temp, gid0)) %>% dplyr::select(-temp) %>% ungroup() %>%
  
          filter(!is.na(name2)) %>% #make sure again that all the names are the
          arrange(gid0,gid1,name2,gid2)           %>% group_by(gid0,gid1,name2) %>% mutate(temp=gid2) %>% fill(temp)          %>% mutate(gid2=ifelse(!is.na(gid0) & !is.na(gid1), temp, gid2)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid0,gid1,name2,geonameid2)     %>% group_by(gid0,gid1,name2) %>% mutate(temp=geonameid2) %>% fill(temp)    %>% mutate(geonameid2=ifelse(!is.na(gid0) & !is.na(gid1), temp, geonameid2)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid0,gid1,name2,feature_code2)  %>% group_by(gid0,gid1,name2) %>% mutate(temp=feature_code2) %>% fill(temp) %>% mutate(feature_code2=ifelse(!is.na(gid0) & !is.na(gid1), temp, feature_code2)) %>% dplyr::select(-temp) %>% ungroup() %>%
          arrange(gid0,gid1,name2,wikidata_id2)   %>% group_by(gid0,gid1,name2) %>% mutate(temp=wikidata_id2) %>% fill(temp)  %>% mutate(wikidata_id2=ifelse(!is.na(gid0) & !is.na(gid1), temp, wikidata_id2)) %>% dplyr::select(-temp) %>% ungroup() %>%
  
          rename(admin2_name_clean=name2)  %>% distinct() 
dim(admin2) #303,189 #325515 #282,060


sapply(admin2, function(x) sum(is.na(x))) #That gets the missing down even more.
#       geonameid0      wikidata_id0              gid0          ISO31661        geonameid1      wikidata_id1              gid1          ISO31662        geonameid2 admin2_name_clean     feature_code2      wikidata_id2              gid2 
#            22,525             23218             21204             24344             36178             40156             23,737             43040             86885                 0            104643             90311             43987 
test <- admin2 %>% count(geonameid0,wikidata_id0,gid0,ISO31661,geonameid1,wikidata_id1,gid1,admin2_name_clean)

admin2 <- admin2 %>% filter(!is.na(gid0)) #for right now we're going to reject all those q code alternate names that don't have a country or state match

saveRDS(admin0,"/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESScovid19/data_temp/admin0.Rds")
saveRDS(admin1,"/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESScovid19/data_temp/admin1.Rds")
saveRDS(admin2,"/media/skynet2/905884f0-7546-4273-9061-12a790830beb/rwd_github_private/NESScovid19/data_temp/admin2.Rds")


```

